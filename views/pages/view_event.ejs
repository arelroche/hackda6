<!DOCTYPE html>
<html>
<head>
  <title>Pick Up!</title>

  <% include ../partials/common_styles.ejs %>

  <!-- Leaflet Scripts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <!-- Leaflet End -->

</head>

<body>

  <% include ../partials/navbar.ejs %>

  <div class="container">

    <h2><%= eventDetails.title ? eventDetails.title : "No Event Title..." %></h2>

    <div class="list-group">
      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Host</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.host ? eventDetails.host : "Anonymous..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Location</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.location_name ? eventDetails.location_name : "...er..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Date</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.date ? eventDetails.date : "...right..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Starting</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.start_time ? eventDetails.start_time : "...sometime..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Ending</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.end_time ? eventDetails.end_time : "...eventually..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Activity</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.activity_type ? eventDetails.activity_type : "...No Activity Type..." %>
        </h4>
      </span>

      <span href="#" class="list-group-item">
        <p class="list-group-item-text">Group Size</p>
        <h4 class="list-group-item-heading">
          <%= eventDetails.group_size ? eventDetails.group_size : "Open Ended!" %>
        </h4>
      </span>
      
    </div>
      <input type="hidden" id="latitude" value="<%=eventDetails.location.coordinates[1]%>">
      <input type="hidden" id="longitude" value="<%=eventDetails.location.coordinates[0]%>">

      <a href="<%=eventDetails.url%>"><button id="goToMaps" type="button" class="btn btn-default">Show Google Map</button></a>
      <button id="getLocation" type="button" class="btn btn-default">Where am I?</button>

    <div>
      <!-- <form class="form-horizontal">

        <div class="form-group">
          <label for="search-event" class="col-sm-2 control-label">Event:</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" name="title" id="search-event" placeholder="e.g. Soccer" value="<%= eventDetails.title %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-host" class="col-sm-2 control-label">Host:</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" name="host" id="search-host" placeholder="" value="<%= eventDetails.host %>">

          </div>
        </div>

        <div class="form-group">
          <label for="search-location" class="col-sm-2 control-label">Location:</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" name="location_name" id="search-location" placeholder="e.g. YMCA" value="<%= eventDetails.location_name %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-date" class="col-sm-2 control-label">Date:</label>
          <div class="col-sm-10">
            <input type="date" class="form-control" name="date" id="search-date" placeholder="" value="<%= eventDetails.date %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-start" class="col-sm-2 control-label">Start Time:</label>
          <div class="col-sm-10">
            <input type="time" class="form-control" name="start_time" id="search-start" placeholder="" value="<%= eventDetails.start_time %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-end" class="col-sm-2 control-label">End Time:</label>
          <div class="col-sm-10">
            <input type="time" class="form-control" name="end_time" id="search-end" placeholder="" value="<%= eventDetails.end_time %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-type" class="col-sm-2 control-label">Event Type:</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" name="activity_type" id="search-type" placeholder="" value="<%= eventDetails.activity_type %>">
          </div>
        </div>

        <div class="form-group">
          <label for="search-size" class="col-sm-2 control-label">Group Size:</label>
          <div class="col-sm-10">
            <input type="number" class="form-control" name="group_size" id="search-size" placeholder="" value="<%= eventDetails.group_size %>">
          </div>
        </div>

        <input type="hidden" id="latitude" value="<%=eventDetails.location.coordinates[1]%>">
        <input type="hidden" id="longitude" value="<%=eventDetails.location.coordinates[0]%>">
        <a href="<%=eventDetails.url%>"><%=eventDetails.url%></a>

        <div class="form-group">
          <div class="col-sm-offset-2 col-sm-10">

            
            <button id="getLocation" type="button" class="btn btn-default">Get Location</button>
            

            <button id="submitForm" type="submit" class="btn btn-success">Submit</button>
            <button id="goToMaps" type="button" class="btn btn-default">Go to Maps</button>
          </div>
        </div>

      </form> -->
      <!-- <form class="form-signin" action="/event/<%- eventId %>?active=false" method="post">
            <button id="btnSignIn" class="btn btn-lg btn-primary btn-block" type="submit">Delete Event!</button>
      </form> -->

    </div>
  </div>

  <br>

  <div class="container">
    <div id="map" style="height: 220px;"></div>
  </div>

</body>
<script>

$(document).ready(function (){

  if (localStorage.latitude && localStorage.longitude) {
    $('#search-lat').val(localStorage.latitude);
    $('#search-long').val(localStorage.longitude);
  }

  //var latitude = localStorage.latitude || 51.505;
  //var longitude = localStorage.longitude || -0.09;

  window.eventLatitude = $("#latitude").val();
  window.eventLongitude = $("#longitude").val();

  console.log("COORDS", eventLatitude, eventLongitude);

  // initialize the map on the "map" div with a given center and zoom
  window.mymap = L.map('map', {
      center: [eventLatitude, eventLongitude],
      zoom: 13
  });

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'mapbox.streets',
    accessToken: 'pk.eyJ1Ijoia2FtaWthejFrIiwiYSI6ImNpcWgyNzd2czA0bXRmeW5wdDJrdDA0b2YifQ.EhJNxc3CbcdkQMR8QdbFAA'
  }).addTo(mymap);

  // Add marker to map at current location
  window.marker1 = L.marker([eventLatitude, eventLongitude]);
  marker1.addTo(mymap);


  $(function() {
    $('#goToMaps').click(function() {
        window.location.href = $("#map-url").val(); 
    });
  });


  //Creating a JSON object to send form data to Server
  (function () {
    $.fn.serializeFormJSON = function () {

        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });

        //Add place JSON and latlng
        // o["place"] = place;
        o["url"] = window.place.url;
        o["formatted_address"] = window.place.formatted_address;
        o["latitude"] = window.finalLatitude;
        o["longitude"] = window.finalLongitude;

        return o;
    };
  })();

  $('form').submit(function (e) {
      e.preventDefault();
      var data = $(this).serializeFormJSON();
      console.log(data);
      $.ajax({
          url: '/events/new',
          data: data,
          type: 'POST',
          success: function(response) {
              console.log("Success",response);
              window.location.href = response.url;
          },
          error: function(error) {
              console.log("Error",error);
          }
      });
  });


});

var placeSearch, autocomplete;

function initAutocomplete() {
  return;
  console.log("MAPS READY!");
  // Create the autocomplete object, restricting the search to geographical
  // location types.
  autocomplete = new google.maps.places.Autocomplete(
      /** @type {!HTMLInputElement} */(document.getElementById('search-location')),
      {types: []});

  // When the user selects an address from the dropdown, populate the address
  // fields in the form.
  autocomplete.addListener('place_changed', fillInAddress);

  //place contains all the information of the selected location
  

}

function fillInAddress() {
  console.log("fillInAddress");
  // Get the place details from the autocomplete object.
  window.place = autocomplete.getPlace();
  console.log(place);
  var geoLocation = place.geometry.location;
  //console.log(geoLocation);
  window.finalLatitude = geoLocation.lat();
  window.finalLongitude = geoLocation.lng();
  marker1.setLatLng([finalLatitude, finalLongitude]);
}    

// Bias the autocomplete object to the user's geographical location,
// as supplied by the browser's 'navigator.geolocation' object.
function geolocate() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var geolocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      var circle = new google.maps.Circle({
        center: geolocation,
        radius: position.coords.accuracy
      });
      autocomplete.setBounds(circle.getBounds());
    });
  }
}

</script>
  <!-- This so that the initAutocomplete is defined when the script is loaded  -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBm7WomiYWSp91pKjHzgw-Z3MA4elcqM7w&libraries=places&callback=initAutocomplete"
        async defer></script>

</html>
